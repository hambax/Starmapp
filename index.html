<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Star Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    body.night-mode {
      --ui-bg: rgba(30, 0, 0, 0.9);
      --ui-border: rgba(255, 50, 50, 0.2);
      --ui-text: #ff6b6b;
      --ui-text-dim: #aa4444;
      --ui-accent: #ff4444;
    }
    body:not(.night-mode) {
      --ui-bg: rgba(0, 0, 30, 0.9);
      --ui-border: rgba(255, 255, 255, 0.1);
      --ui-text: #ffffff;
      --ui-text-dim: #888888;
      --ui-accent: #4a6cf7;
    }
    #sky-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,20,0.95);
      z-index: 1000;
      padding: 20px;
      text-align: center;
      touch-action: auto;
    }
    #ui-overlay.hidden { display: none; }
    h1 { font-size: 28px; margin-bottom: 10px; }
    .subtitle { color: #88f; margin-bottom: 30px; font-size: 14px; }
    .btn {
      background: linear-gradient(135deg, #4a6cf7, #2d4ad8);
      border: none;
      color: white;
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px;
      min-width: 240px;
      transition: transform 0.2s, box-shadow 0.2s;
      -webkit-tap-highlight-color: rgba(255,255,255,0.2);
      touch-action: manipulation;
      user-select: none;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: #444; cursor: not-allowed; transform: none; opacity: 0.7; }
    .btn.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .status { margin-top: 20px; font-size: 14px; color: #aaa; max-width: 300px; min-height: 24px; }
    
    #info-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: var(--ui-bg);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 12px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid var(--ui-border);
      pointer-events: none;
      color: var(--ui-text);
    }
    #info-panel div { margin: 4px 0; }
    .label { color: var(--ui-text-dim); }
    
    #direction-display {
      position: fixed;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ui-bg);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 16px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid var(--ui-border);
      pointer-events: none;
      color: var(--ui-text);
    }
    
    #legend {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--ui-bg);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 11px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid var(--ui-border);
      pointer-events: none;
      color: var(--ui-text);
    }
    .legend-item { display: flex; align-items: center; margin: 4px 0; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    
    .permission-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 300px;
    }
    .step-icon { font-size: 16px; margin-right: 12px; width: 40px; text-align: center; font-weight: bold; }
    .step-status { font-size: 16px; margin-left: auto; }
    .step-text { text-align: left; flex: 1; }
    .step-title { font-weight: bold; font-size: 14px; }
    .step-desc { font-size: 11px; color: #888; }
    .sensor-note {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.5);
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 12px;
      max-width: 300px;
    }
    
    /* Control Panel */
    #control-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--ui-bg);
      z-index: 100;
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--ui-border);
      max-height: 60vh;
      overflow-y: auto;
    }
    
    @media (min-width: 768px) {
      #control-panel {
        right: auto;
        width: 350px;
        border-radius: 0 10px 0 0;
        border-right: 1px solid var(--ui-border);
        max-height: 80vh;
      }
      #direction-display {
        bottom: 20px;
      }
    }
    
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--ui-border);
      position: sticky;
      top: 0;
      background: var(--ui-bg);
      z-index: 10;
    }
    
    .panel-tab {
      flex: 1;
      padding: 12px 8px;
      background: none;
      border: none;
      color: var(--ui-text-dim);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }
    
    .panel-tab.active {
      color: var(--ui-text);
      border-bottom-color: var(--ui-accent);
    }
    
    .panel-tab:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .panel-content {
      padding: 15px;
      display: none;
    }
    
    .panel-content.active {
      display: block;
    }
    
    .control-section {
      margin-bottom: 15px;
    }
    
    .control-section-title {
      font-size: 11px;
      color: var(--ui-text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .control-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    
    .control-input-group {
      flex: 1;
    }
    
    .control-input-group label {
      display: block;
      font-size: 10px;
      color: var(--ui-text-dim);
      margin-bottom: 4px;
    }
    
    .control-input-group input,
    .control-input-group select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--ui-border);
      background: rgba(255,255,255,0.1);
      color: var(--ui-text);
      font-size: 14px;
      font-family: inherit;
    }
    
    .control-input-group input:focus,
    .control-input-group select:focus {
      outline: none;
      border-color: var(--ui-accent);
    }
    
    .control-btn {
      padding: 8px 12px;
      border: 1px solid var(--ui-border);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: var(--ui-text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
      white-space: nowrap;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .control-btn.active {
      background: var(--ui-accent);
      border-color: var(--ui-accent);
    }
    
    .control-btn.primary {
      background: var(--ui-accent);
      border-color: var(--ui-accent);
    }
    
    .control-btn-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .control-btn-grid.cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .control-btn-grid.cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    
    .object-btn {
      padding: 10px 8px;
      text-align: center;
    }
    
    .object-btn .name {
      font-size: 11px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .slider-container input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.2);
    }
    
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--ui-accent);
      cursor: pointer;
    }
    
    .slider-value {
      min-width: 40px;
      text-align: right;
      font-size: 12px;
      color: var(--ui-text-dim);
    }
    
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--ui-border);
    }
    
    .toggle-row:last-child {
      border-bottom: none;
    }
    
    .toggle-label {
      font-size: 13px;
    }
    
    .toggle-switch {
      width: 44px;
      height: 24px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle-switch.active {
      background: var(--ui-accent);
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }
    
    .toggle-switch.active::after {
      transform: translateX(20px);
    }
    
    .time-display-large {
      text-align: center;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .time-display-large .time-big {
      font-size: 28px;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
      color: var(--ui-text);
    }
    
    .time-display-large .date-small {
      font-size: 12px;
      color: var(--ui-text-dim);
      margin-top: 4px;
    }
    
    .time-mode-indicator {
      display: inline-block;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      background: #22c55e;
      color: white;
      margin-left: 8px;
      vertical-align: middle;
    }
    
    .time-mode-indicator.planning {
      background: #f59e0b;
    }
    
    .object-info-card {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }
    
    .object-info-card h4 {
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .object-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }
    
    .object-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .object-info-item .label {
      font-size: 10px;
      color: var(--ui-text-dim);
    }
    
    .object-info-item .value {
      font-weight: bold;
    }
    
    .crosshair {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 45;
      display: none;
    }
    
    .crosshair.visible {
      display: block;
    }
    
    .crosshair svg {
      width: 60px;
      height: 60px;
    }
    
    .sensor-status {
      font-size: 10px;
      color: var(--ui-text-dim);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <canvas id="sky-canvas"></canvas>
  
  <!-- Crosshair -->
  <div class="crosshair" id="crosshair">
    <svg viewBox="0 0 60 60">
      <circle cx="30" cy="30" r="20" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
      <line x1="30" y1="5" x2="30" y2="20" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
      <line x1="30" y1="40" x2="30" y2="55" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
      <line x1="5" y1="30" x2="20" y2="30" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
      <line x1="40" y1="30" x2="55" y2="30" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
    </svg>
  </div>
  
  <div id="ui-overlay">
    <h1>Star Tracker</h1>
    <p class="subtitle">Point your phone at the sky to see stars and planets</p>
    
    <div class="permission-step">
      <span class="step-icon">GPS</span>
      <div class="step-text">
        <div class="step-title">Location</div>
        <div class="step-desc">To show stars visible from your position</div>
      </div>
      <span class="step-status" id="loc-status">...</span>
    </div>
    
    <div class="permission-step">
      <span class="step-icon">IMU</span>
      <div class="step-text">
        <div class="step-title">Gyroscope and Compass</div>
        <div class="step-desc">To track phone orientation and heading</div>
      </div>
      <span class="step-status" id="gyro-status">...</span>
    </div>
    
    <div class="sensor-note" id="ios-note" style="display:none;">
      <strong>iOS Users:</strong> You will be prompted to allow "Motion and Orientation" access. This includes both the gyroscope and compass sensors.
    </div>
    
    <button class="btn" id="location-btn" type="button">Grant Location Access</button>
    <button class="btn" id="sensor-btn" type="button" style="display:none;">Enable Sensors</button>
    <button class="btn success" id="start-btn" type="button" style="display:none;">Start Star Tracking</button>
    
    <p class="status" id="status"></p>
  </div>
  
  <div id="info-panel" style="display:none;">
    <div><span class="label">Location:</span> <span id="loc-display">--</span></div>
    <div><span class="label">Facing:</span> <span id="az-display">--</span></div>
    <div><span class="label">Elevation:</span> <span id="alt-display">--</span></div>
    <div><span class="label">Sensors:</span> <span id="sensor-display">--</span></div>
    <div class="sensor-status" id="compass-status"></div>
  </div>
  
  <div id="direction-display" style="display:none;">
    <span id="direction">N</span> <span id="degrees">0</span>
  </div>
  
  <div id="legend" style="display:none;">
    <div class="legend-item"><div class="legend-dot" style="background:#FFD700;"></div> Sun</div>
    <div class="legend-item"><div class="legend-dot" style="background:#E8E8E8;"></div> Moon</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFA500;"></div> Planets</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFFFFF;"></div> Stars</div>
  </div>
  
  <!-- Control Panel -->
  <div id="control-panel" style="display:none;">
    <div class="panel-tabs">
      <button class="panel-tab active" data-tab="time">Time</button>
      <button class="panel-tab" data-tab="find">Find</button>
      <button class="panel-tab" data-tab="view">View</button>
      <button class="panel-tab" data-tab="settings">Settings</button>
    </div>
    
    <!-- Time Tab -->
    <div class="panel-content active" id="tab-time">
      <div class="time-display-large">
        <div class="time-big" id="display-time">--:--:--</div>
        <span class="time-mode-indicator" id="time-mode-badge">LIVE</span>
        <div class="date-small" id="display-date">----</div>
      </div>
      
      <div class="control-section">
        <div class="control-row">
          <div class="control-input-group">
            <label>Date</label>
            <input type="date" id="date-input">
          </div>
          <div class="control-input-group">
            <label>Time</label>
            <input type="time" id="time-input">
          </div>
        </div>
        
        <div class="control-btn-grid cols-4">
          <button class="control-btn primary" id="now-btn">Now</button>
          <button class="control-btn" id="plus1h-btn">+1h</button>
          <button class="control-btn" id="plus3h-btn">+3h</button>
          <button class="control-btn" id="plus6h-btn">+6h</button>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Quick Times</div>
        <div class="control-btn-grid cols-2">
          <button class="control-btn" id="sunset-btn">Sunset</button>
          <button class="control-btn" id="sunrise-btn">Sunrise</button>
          <button class="control-btn" id="midnight-btn">Midnight</button>
          <button class="control-btn" id="golden-btn">Golden Hour</button>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Time Scrubber</div>
        <div class="slider-container">
          <input type="range" id="time-scrubber" min="0" max="1440" value="720">
          <span class="slider-value" id="scrubber-value">12:00</span>
        </div>
      </div>
    </div>
    
    <!-- Find Tab -->
    <div class="panel-content" id="tab-find">
      <div class="control-section">
        <div class="control-section-title">Solar System</div>
        <div class="control-btn-grid">
          <button class="control-btn object-btn" data-find="Sun">
            <span class="name">Sun</span>
          </button>
          <button class="control-btn object-btn" data-find="Moon">
            <span class="name">Moon</span>
          </button>
          <button class="control-btn object-btn" data-find="Mercury">
            <span class="name">Mercury</span>
          </button>
          <button class="control-btn object-btn" data-find="Venus">
            <span class="name">Venus</span>
          </button>
          <button class="control-btn object-btn" data-find="Mars">
            <span class="name">Mars</span>
          </button>
          <button class="control-btn object-btn" data-find="Jupiter">
            <span class="name">Jupiter</span>
          </button>
          <button class="control-btn object-btn" data-find="Saturn">
            <span class="name">Saturn</span>
          </button>
          <button class="control-btn object-btn" data-find="Polaris">
            <span class="name">Polaris</span>
          </button>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Bright Stars</div>
        <div class="control-btn-grid cols-4">
          <button class="control-btn" data-find="Sirius">Sirius</button>
          <button class="control-btn" data-find="Vega">Vega</button>
          <button class="control-btn" data-find="Arcturus">Arcturus</button>
          <button class="control-btn" data-find="Capella">Capella</button>
          <button class="control-btn" data-find="Rigel">Rigel</button>
          <button class="control-btn" data-find="Betelgeuse">Betelgeuse</button>
          <button class="control-btn" data-find="Altair">Altair</button>
          <button class="control-btn" data-find="Deneb">Deneb</button>
        </div>
      </div>
      
      <div class="object-info-card" id="object-info" style="display:none;">
        <h4><span id="info-object-name">--</span></h4>
        <div class="object-info-grid">
          <div class="object-info-item">
            <span class="label">Altitude</span>
            <span class="value" id="info-altitude">--</span>
          </div>
          <div class="object-info-item">
            <span class="label">Azimuth</span>
            <span class="value" id="info-azimuth">--</span>
          </div>
          <div class="object-info-item">
            <span class="label">Direction</span>
            <span class="value" id="info-direction">--</span>
          </div>
          <div class="object-info-item">
            <span class="label">Visibility</span>
            <span class="value" id="info-visibility">--</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- View Tab -->
    <div class="panel-content" id="tab-view">
      <div class="control-section">
        <div class="control-section-title">Field of View</div>
        <div class="slider-container">
          <span style="font-size: 12px;">Wide</span>
          <input type="range" id="fov-slider" min="30" max="120" value="80">
          <span style="font-size: 12px;">Narrow</span>
        </div>
        <div style="text-align: center; margin-top: 5px;">
          <span class="slider-value" id="fov-value">80 deg</span>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Star Brightness Filter</div>
        <div class="slider-container">
          <span style="font-size: 12px;">Few</span>
          <input type="range" id="mag-slider" min="-1" max="6" value="2" step="0.5">
          <span style="font-size: 12px;">Many</span>
        </div>
        <div style="text-align: center; margin-top: 5px;">
          <span class="slider-value">Magnitude limit: <span id="mag-value">2.0</span></span>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Quick Views</div>
        <div class="control-btn-grid cols-2">
          <button class="control-btn" id="view-north">Look North</button>
          <button class="control-btn" id="view-south">Look South</button>
          <button class="control-btn" id="view-east">Look East</button>
          <button class="control-btn" id="view-west">Look West</button>
          <button class="control-btn" id="view-zenith">Zenith (Up)</button>
          <button class="control-btn" id="view-horizon">Horizon</button>
        </div>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div class="panel-content" id="tab-settings">
      <div class="control-section">
        <div class="toggle-row">
          <span class="toggle-label">Night Mode (Red)</span>
          <div class="toggle-switch" id="toggle-night"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Show Crosshair</span>
          <div class="toggle-switch" id="toggle-crosshair"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Show Grid Lines</span>
          <div class="toggle-switch" id="toggle-grid"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Show Labels</span>
          <div class="toggle-switch active" id="toggle-labels"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Show Horizon</span>
          <div class="toggle-switch active" id="toggle-horizon"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Lock Sensors</span>
          <div class="toggle-switch" id="toggle-gyro-lock"></div>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">Background Stars</div>
        <div class="slider-container">
          <span style="font-size: 12px;">None</span>
          <input type="range" id="bg-stars-slider" min="0" max="500" value="400">
          <span style="font-size: 12px;">Many</span>
        </div>
      </div>
      
      <div class="control-section">
        <div class="control-section-title">About</div>
        <p style="font-size: 11px; color: var(--ui-text-dim); line-height: 1.5;">
          Star Tracker helps you identify stars and planets in the night sky and plan your astrophotography sessions. Point your device at the sky or use touch controls to navigate.
        </p>
      </div>
    </div>
  </div>

  <script>
    const DEG2RAD = Math.PI / 180;
    const RAD2DEG = 180 / Math.PI;
    
    // ==================== ASTRONOMICAL CALCULATIONS ====================
    function julianDate(date) {
      const y = date.getUTCFullYear();
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate() + date.getUTCHours()/24 + date.getUTCMinutes()/1440 + date.getUTCSeconds()/86400;
      const a = Math.floor((14 - m) / 12);
      const yy = y + 4800 - a;
      const mm = m + 12 * a - 3;
      return d + Math.floor((153 * mm + 2) / 5) + 365 * yy + Math.floor(yy / 4) - Math.floor(yy / 100) + Math.floor(yy / 400) - 32045;
    }
    
    function localSiderealTime(jd, longitude) {
      const T = (jd - 2451545.0) / 36525;
      let LST = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * T * T - T * T * T / 38710000;
      LST = LST + longitude;
      LST = ((LST % 360) + 360) % 360;
      return LST;
    }
    
    function raDecToAltAz(ra, dec, lat, lst) {
      const ha = (lst - ra + 360) % 360;
      const haRad = ha * DEG2RAD;
      const decRad = dec * DEG2RAD;
      const latRad = lat * DEG2RAD;
      
      const sinAlt = Math.sin(decRad) * Math.sin(latRad) + Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
      const alt = Math.asin(sinAlt) * RAD2DEG;
      
      const cosAz = (Math.sin(decRad) - Math.sin(latRad) * sinAlt) / (Math.cos(latRad) * Math.cos(alt * DEG2RAD));
      let az = Math.acos(Math.max(-1, Math.min(1, cosAz))) * RAD2DEG;
      if (Math.sin(haRad) > 0) az = 360 - az;
      
      return { alt, az };
    }
    
    function getSunPosition(jd) {
      const n = jd - 2451545.0;
      const L = (280.460 + 0.9856474 * n) % 360;
      const g = (357.528 + 0.9856003 * n) % 360;
      const gRad = g * DEG2RAD;
      const lambda = L + 1.915 * Math.sin(gRad) + 0.020 * Math.sin(2 * gRad);
      const epsilon = 23.439 - 0.0000004 * n;
      const lambdaRad = lambda * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(Math.cos(epsilonRad) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilonRad) * Math.sin(lambdaRad)) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Sun', color: '#FFD700', size: 20 };
    }
    
    function getMoonPosition(jd) {
      const L = (218.316 + 13.176396 * (jd - 2451545.0)) % 360;
      const M = (134.963 + 13.064993 * (jd - 2451545.0)) % 360;
      const F = (93.272 + 13.229350 * (jd - 2451545.0)) % 360;
      
      const longitude = L + 6.289 * Math.sin(M * DEG2RAD);
      const latitude = 5.128 * Math.sin(F * DEG2RAD);
      const epsilon = 23.439;
      
      const lambdaRad = longitude * DEG2RAD;
      const betaRad = latitude * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(
        Math.sin(lambdaRad) * Math.cos(epsilonRad) - Math.tan(betaRad) * Math.sin(epsilonRad),
        Math.cos(lambdaRad)
      ) * RAD2DEG;
      const dec = Math.asin(
        Math.sin(betaRad) * Math.cos(epsilonRad) + Math.cos(betaRad) * Math.sin(epsilonRad) * Math.sin(lambdaRad)
      ) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Moon', color: '#E8E8E8', size: 18 };
    }
    
    function getPlanetPosition(jd, planet) {
      const n = jd - 2451545.0;
      const planets = {
        Mercury: { L0: 252.251, Lrate: 4.09233 },
        Venus: { L0: 181.980, Lrate: 1.60213 },
        Mars: { L0: 355.433, Lrate: 0.52403 },
        Jupiter: { L0: 34.351, Lrate: 0.08309 },
        Saturn: { L0: 50.077, Lrate: 0.03346 }
      };
      
      const p = planets[planet];
      const L = (p.L0 + p.Lrate * n) % 360;
      const epsilon = 23.439;
      const lambdaRad = L * DEG2RAD;
      const ra = Math.atan2(Math.cos(epsilon * DEG2RAD) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilon * DEG2RAD) * Math.sin(lambdaRad)) * RAD2DEG;
      
      const colors = { Mercury: '#B5B5B5', Venus: '#FFFACD', Mars: '#FF6B4A', Jupiter: '#FFB347', Saturn: '#F4D03F' };
      const sizes = { Mercury: 6, Venus: 10, Mars: 8, Jupiter: 14, Saturn: 12 };
      
      return { ra: (ra + 360) % 360, dec, name: planet, color: colors[planet], size: sizes[planet] };
    }
    
    function getSunTimes(date, lat, lng) {
      const jd = julianDate(date);
      const n = Math.floor(jd - 2451545.0 + 0.0008);
      const Jstar = n - lng / 360;
      const M = (357.5291 + 0.98560028 * Jstar) % 360;
      const C = 1.9148 * Math.sin(M * DEG2RAD) + 0.02 * Math.sin(2 * M * DEG2RAD);
      const lambda = (M + C + 180 + 102.9372) % 360;
      const Jtransit = 2451545.0 + Jstar + 0.0053 * Math.sin(M * DEG2RAD) - 0.0069 * Math.sin(2 * lambda * DEG2RAD);
      const delta = Math.asin(Math.sin(lambda * DEG2RAD) * Math.sin(23.44 * DEG2RAD)) * RAD2DEG;
      const cosOmega = (Math.sin(-0.83 * DEG2RAD) - Math.sin(lat * DEG2RAD) * Math.sin(delta * DEG2RAD)) / 
                       (Math.cos(lat * DEG2RAD) * Math.cos(delta * DEG2RAD));
      
      if (Math.abs(cosOmega) > 1) return null;
      
      const omega = Math.acos(cosOmega) * RAD2DEG;
      const Jrise = Jtransit - omega / 360;
      const Jset = Jtransit + omega / 360;
      
      function jdToDate(jd) {
        const Z = Math.floor(jd + 0.5);
        const F = jd + 0.5 - Z;
        const A = Math.floor((Z - 1867216.25) / 36524.25);
        const B = Z + 1 + A - Math.floor(A / 4);
        const C = B + 1524;
        const D = Math.floor((C - 122.1) / 365.25);
        const E = Math.floor(365.25 * D);
        const G = Math.floor((C - E) / 30.6001);
        const day = C - E - Math.floor(30.6001 * G) + F;
        const month = G < 14 ? G - 1 : G - 13;
        const year = month > 2 ? D - 4716 : D - 4715;
        const hours = (day % 1) * 24;
        return new Date(year, month - 1, Math.floor(day), Math.floor(hours), Math.floor((hours % 1) * 60));
      }
      
      return {
        sunrise: jdToDate(Jrise),
        sunset: jdToDate(Jset),
        noon: jdToDate(Jtransit)
      };
    }
    
    const BRIGHT_STARS = [
      ['Sirius', 101.29, -16.72, -1.46], ['Canopus', 95.99, -52.70, -0.72],
      ['Arcturus', 213.92, 19.18, -0.05], ['Vega', 279.23, 38.78, 0.03],
      ['Capella', 79.17, 45.99, 0.08], ['Rigel', 78.63, -8.20, 0.13],
      ['Procyon', 114.83, 5.22, 0.34], ['Betelgeuse', 88.79, 7.41, 0.42],
      ['Altair', 297.70, 8.87, 0.76], ['Aldebaran', 68.98, 16.51, 0.85],
      ['Antares', 247.35, -26.43, 0.96], ['Spica', 201.30, -11.16, 0.97],
      ['Pollux', 116.33, 28.03, 1.14], ['Fomalhaut', 344.41, -29.62, 1.16],
      ['Deneb', 310.36, 45.28, 1.25], ['Regulus', 152.09, 11.97, 1.35],
      ['Polaris', 37.95, 89.26, 1.98], ['Castor', 113.65, 31.89, 1.58]
    ];
    
    let BACKGROUND_STARS = [];
    function generateBackgroundStars(count) {
      BACKGROUND_STARS = [];
      for (let i = 0; i < count; i++) {
        const az = (Math.sin(i * 567.89) * 0.5 + 0.5) * 360;
        const alt = (Math.cos(i * 123.45) * 0.5 + 0.5) * 180 - 90;
        const size = (i % 4) * 0.3 + 0.4;
        const brightness = 0.3 + (i % 5) * 0.1;
        BACKGROUND_STARS.push({ az, alt, size, brightness });
      }
    }
    generateBackgroundStars(400);
    
    // ==================== APP STATE ====================
    let state = {
      hasLocation: false,
      hasGyroscope: false,
      hasCompass: false,
      gyroActive: false,
      compassActive: false,
      sensorsLocked: false,
      latitude: 51.5,
      longitude: -0.1,
      alpha: 0, beta: 0, gamma: 0,
      compassHeading: null,
      azimuth: 180,
      altitude: 45,
      useCustomTime: false,
      customTime: new Date(),
      // View settings
      fov: 80,
      maxMagnitude: 2.0,
      showLabels: true,
      showHorizon: true,
      showGrid: false,
      showCrosshair: false,
      nightMode: false,
      bgStarCount: 400,
      // Selected object
      selectedObject: null
    };
    
    const canvas = document.getElementById('sky-canvas');
    const ctx = canvas.getContext('2d');
    
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    if (isIOS) {
      document.getElementById('ios-note').style.display = 'block';
    }
    
    // ==================== UI FUNCTIONS ====================
    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }
    
    function hideOverlay() {
      document.getElementById('ui-overlay').classList.add('hidden');
      document.getElementById('info-panel').style.display = 'block';
      document.getElementById('direction-display').style.display = 'block';
      document.getElementById('legend').style.display = 'block';
      document.getElementById('control-panel').style.display = 'block';
      initTimePanel();
      initControls();
    }
    
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    // ==================== TAB SWITCHING ====================
    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });
    
    // ==================== TIME CONTROLS ====================
    function initTimePanel() {
      const now = new Date();
      updateTimeInputs(now);
      updateTimeDisplay(now);
      
      const scrubber = document.getElementById('time-scrubber');
      scrubber.value = now.getHours() * 60 + now.getMinutes();
      updateScrubberDisplay(scrubber.value);
    }
    
    function updateTimeInputs(date) {
      const dateStr = date.toISOString().split('T')[0];
      const timeStr = date.toTimeString().slice(0, 5);
      document.getElementById('date-input').value = dateStr;
      document.getElementById('time-input').value = timeStr;
    }
    
    function updateTimeDisplay(date) {
      document.getElementById('display-time').textContent = date.toLocaleTimeString();
      document.getElementById('display-date').textContent = date.toLocaleDateString(undefined, { 
        weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' 
      });
      
      const badge = document.getElementById('time-mode-badge');
      if (state.useCustomTime) {
        badge.textContent = 'PLANNING';
        badge.classList.add('planning');
      } else {
        badge.textContent = 'LIVE';
        badge.classList.remove('planning');
      }
    }
    
    function updateScrubberDisplay(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      document.getElementById('scrubber-value').textContent = 
        `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }
    
    function getSelectedTime() {
      return state.useCustomTime ? state.customTime : new Date();
    }
    
    function setCustomTime(date) {
      state.useCustomTime = true;
      state.customTime = date;
      updateTimeInputs(date);
      updateTimeDisplay(date);
      const mins = date.getHours() * 60 + date.getMinutes();
      document.getElementById('time-scrubber').value = mins;
      updateScrubberDisplay(mins);
    }
    
    function setLiveTime() {
      state.useCustomTime = false;
      const now = new Date();
      updateTimeInputs(now);
      updateTimeDisplay(now);
    }
    
    // Time panel events
    document.getElementById('date-input').addEventListener('change', function() {
      const dateVal = this.value;
      const timeVal = document.getElementById('time-input').value || '12:00';
      const newDate = new Date(dateVal + 'T' + timeVal);
      if (!isNaN(newDate)) setCustomTime(newDate);
    });
    
    document.getElementById('time-input').addEventListener('change', function() {
      const dateVal = document.getElementById('date-input').value || new Date().toISOString().split('T')[0];
      const timeVal = this.value;
      const newDate = new Date(dateVal + 'T' + timeVal);
      if (!isNaN(newDate)) setCustomTime(newDate);
    });
    
    document.getElementById('time-scrubber').addEventListener('input', function() {
      const minutes = parseInt(this.value);
      updateScrubberDisplay(minutes);
      const base = state.useCustomTime ? state.customTime : new Date();
      const newDate = new Date(base);
      newDate.setHours(Math.floor(minutes / 60), minutes % 60, 0, 0);
      state.useCustomTime = true;
      state.customTime = newDate;
      updateTimeInputs(newDate);
      updateTimeDisplay(newDate);
    });
    
    document.getElementById('now-btn').addEventListener('click', setLiveTime);
    
    document.getElementById('plus1h-btn').addEventListener('click', () => {
      const base = getSelectedTime();
      setCustomTime(new Date(base.getTime() + 60 * 60 * 1000));
    });
    
    document.getElementById('plus3h-btn').addEventListener('click', () => {
      const base = getSelectedTime();
      setCustomTime(new Date(base.getTime() + 3 * 60 * 60 * 1000));
    });
    
    document.getElementById('plus6h-btn').addEventListener('click', () => {
      const base = getSelectedTime();
      setCustomTime(new Date(base.getTime() + 6 * 60 * 60 * 1000));
    });
    
    document.getElementById('sunset-btn').addEventListener('click', () => {
      const times = getSunTimes(new Date(), state.latitude, state.longitude);
      if (times) setCustomTime(times.sunset);
    });
    
    document.getElementById('sunrise-btn').addEventListener('click', () => {
      const times = getSunTimes(new Date(), state.latitude, state.longitude);
      if (times) setCustomTime(times.sunrise);
    });
    
    document.getElementById('midnight-btn').addEventListener('click', () => {
      const d = new Date();
      d.setHours(24, 0, 0, 0);
      setCustomTime(d);
    });
    
    document.getElementById('golden-btn').addEventListener('click', () => {
      const times = getSunTimes(new Date(), state.latitude, state.longitude);
      if (times) {
        const golden = new Date(times.sunset.getTime() - 60 * 60 * 1000);
        setCustomTime(golden);
      }
    });
    
    // ==================== FIND OBJECT CONTROLS ====================
    function findObject(name) {
      const time = getSelectedTime();
      const jd = julianDate(time);
      const lst = localSiderealTime(jd, state.longitude);
      let obj = null;
      
      if (name === 'Sun') obj = getSunPosition(jd);
      else if (name === 'Moon') obj = getMoonPosition(jd);
      else if (['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'].includes(name)) {
        obj = getPlanetPosition(jd, name);
      } else {
        const star = BRIGHT_STARS.find(s => s[0] === name);
        if (star) {
          obj = { ra: star[1], dec: star[2], name: star[0] };
        }
      }
      
      if (obj) {
        const { alt, az } = raDecToAltAz(obj.ra, obj.dec, state.latitude, lst);
        state.azimuth = az;
        state.altitude = alt;
        state.selectedObject = name;
        showObjectInfo(name, alt, az);
      }
    }
    
    function showObjectInfo(name, alt, az) {
      document.getElementById('object-info').style.display = 'block';
      document.getElementById('info-object-name').textContent = name;
      document.getElementById('info-altitude').textContent = `${alt.toFixed(1)} deg`;
      document.getElementById('info-azimuth').textContent = `${az.toFixed(1)} deg`;
      
      const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      document.getElementById('info-direction').textContent = dirs[Math.round(az / 45) % 8];
      document.getElementById('info-visibility').textContent = alt > 0 ? 'Above horizon' : 'Below horizon';
    }
    
    document.querySelectorAll('[data-find]').forEach(btn => {
      btn.addEventListener('click', () => findObject(btn.dataset.find));
    });
    
    // ==================== VIEW CONTROLS ====================
    function initControls() {
      document.getElementById('fov-slider').addEventListener('input', function() {
        state.fov = parseInt(this.value);
        document.getElementById('fov-value').textContent = state.fov + ' deg';
      });
      
      document.getElementById('mag-slider').addEventListener('input', function() {
        state.maxMagnitude = parseFloat(this.value);
        document.getElementById('mag-value').textContent = state.maxMagnitude.toFixed(1);
      });
      
      document.getElementById('bg-stars-slider').addEventListener('input', function() {
        state.bgStarCount = parseInt(this.value);
        generateBackgroundStars(state.bgStarCount);
      });
      
      document.getElementById('view-north').addEventListener('click', () => { state.azimuth = 0; state.altitude = 20; });
      document.getElementById('view-south').addEventListener('click', () => { state.azimuth = 180; state.altitude = 20; });
      document.getElementById('view-east').addEventListener('click', () => { state.azimuth = 90; state.altitude = 20; });
      document.getElementById('view-west').addEventListener('click', () => { state.azimuth = 270; state.altitude = 20; });
      document.getElementById('view-zenith').addEventListener('click', () => { state.altitude = 90; });
      document.getElementById('view-horizon').addEventListener('click', () => { state.altitude = 0; });
      
      setupToggle('toggle-night', (active) => {
        state.nightMode = active;
        document.body.classList.toggle('night-mode', active);
      });
      
      setupToggle('toggle-crosshair', (active) => {
        state.showCrosshair = active;
        document.getElementById('crosshair').classList.toggle('visible', active);
      });
      
      setupToggle('toggle-grid', (active) => { state.showGrid = active; });
      setupToggle('toggle-labels', (active) => { state.showLabels = active; }, true);
      setupToggle('toggle-horizon', (active) => { state.showHorizon = active; }, true);
      setupToggle('toggle-gyro-lock', (active) => { state.sensorsLocked = active; });
    }
    
    function setupToggle(id, callback, initiallyActive = false) {
      const toggle = document.getElementById(id);
      if (initiallyActive) toggle.classList.add('active');
      toggle.addEventListener('click', () => {
        toggle.classList.toggle('active');
        callback(toggle.classList.contains('active'));
      });
    }
    
    // ==================== LOCATION PERMISSION ====================
    const locationBtn = document.getElementById('location-btn');
    locationBtn.addEventListener('click', handleLocationClick);
    locationBtn.addEventListener('touchend', function(e) { e.preventDefault(); handleLocationClick(); });
    
    async function handleLocationClick() {
      const btn = document.getElementById('location-btn');
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = 'Requesting...';
      updateStatus('Please allow location access...');
      
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000 });
        });
        
        state.latitude = position.coords.latitude;
        state.longitude = position.coords.longitude;
        state.hasLocation = true;
        
        document.getElementById('loc-status').textContent = 'OK';
        document.getElementById('loc-display').textContent = `${state.latitude.toFixed(2)}, ${state.longitude.toFixed(2)}`;
        btn.textContent = 'Location Granted';
        btn.classList.add('success');
        updateStatus('Location acquired. Now enable sensors.');
      } catch (e) {
        document.getElementById('loc-status').textContent = 'Default';
        btn.textContent = 'Using Default Location';
        btn.classList.add('warning');
        state.hasLocation = true;
        updateStatus('Using default location (London).');
      }
      
      document.getElementById('sensor-btn').style.display = 'block';
    }
    
    // ==================== SENSOR PERMISSION (Gyroscope + Compass) ====================
    const sensorBtn = document.getElementById('sensor-btn');
    sensorBtn.addEventListener('click', handleSensorClick);
    sensorBtn.addEventListener('touchend', function(e) { e.preventDefault(); handleSensorClick(); });
    
    async function handleSensorClick() {
      const btn = document.getElementById('sensor-btn');
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = 'Requesting...';
      updateStatus('Please allow motion and orientation access...');
      
      let permissionGranted = false;
      
      // iOS 13+ requires explicit permission request
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceOrientationEvent.requestPermission();
          permissionGranted = (permission === 'granted');
        } catch (e) {
          console.error('Permission request failed:', e);
        }
      } else {
        // Android and older iOS - permission not required
        permissionGranted = true;
      }
      
      if (permissionGranted) {
        // Listen for orientation events (includes both gyro and compass data)
        window.addEventListener('deviceorientation', handleOrientation, true);
        window.addEventListener('deviceorientationabsolute', handleOrientationAbsolute, true);
        
        // Wait to see if we actually get data
        await new Promise(r => setTimeout(r, 1000));
        
        let statusParts = [];
        if (state.gyroActive) {
          state.hasGyroscope = true;
          statusParts.push('Gyro');
        }
        if (state.compassActive) {
          state.hasCompass = true;
          statusParts.push('Compass');
        }
        
        if (statusParts.length > 0) {
          document.getElementById('gyro-status').textContent = 'OK';
          btn.textContent = 'Sensors Active';
          btn.classList.add('success');
          updateStatus(`${statusParts.join(' + ')} working. Ready to start.`);
        } else {
          document.getElementById('gyro-status').textContent = 'N/A';
          btn.textContent = 'Using Touch Controls';
          btn.classList.add('warning');
          updateStatus('No sensor data. Use touch to navigate.');
        }
      } else {
        document.getElementById('gyro-status').textContent = 'Denied';
        btn.textContent = 'Permission Denied';
        btn.classList.add('warning');
        updateStatus('Sensor access denied. Use touch to navigate.');
      }
      
      document.getElementById('start-btn').style.display = 'block';
    }
    
    function handleOrientation(event) {
      if (state.sensorsLocked) return;
      
      // Check if we have gyro data
      if (event.beta !== null && event.gamma !== null) {
        state.gyroActive = true;
        state.alpha = event.alpha || 0;
        state.beta = event.beta || 0;
        state.gamma = event.gamma || 0;
        
        // FIXED: Calculate altitude from beta
        // When phone is vertical (beta=90), looking at horizon (alt=0)
        // When tilting phone up (beta increases past 90), looking up (alt increases)
        // When tilting phone down (beta decreases below 90), looking down (alt decreases)
        state.altitude = state.beta - 90;
        state.altitude = Math.max(-90, Math.min(90, state.altitude));
        
        // Check for compass data (iOS provides webkitCompassHeading)
        if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
          state.compassActive = true;
          state.compassHeading = event.webkitCompassHeading;
          state.azimuth = event.webkitCompassHeading;
        } else if (event.absolute) {
          // Some browsers provide absolute orientation
          state.compassActive = true;
          state.azimuth = (360 - state.alpha) % 360;
        } else {
          // Fallback to relative orientation
          state.azimuth = (360 - state.alpha) % 360;
        }
      }
    }
    
    function handleOrientationAbsolute(event) {
      // This event provides compass-corrected orientation on Android
      if (state.sensorsLocked) return;
      
      if (event.alpha !== null && event.absolute) {
        state.compassActive = true;
        state.azimuth = (360 - event.alpha) % 360;
      }
    }
    
    // ==================== START BUTTON ====================
    const startBtn = document.getElementById('start-btn');
    startBtn.addEventListener('click', handleStartClick);
    startBtn.addEventListener('touchend', function(e) { e.preventDefault(); handleStartClick(); });
    
    function handleStartClick() {
      hideOverlay();
      requestAnimationFrame(animate);
    }
    
    // ==================== TOUCH/MOUSE CONTROLS ====================
    let touchStart = { x: 0, y: 0 };
    let isDragging = false;
    
    canvas.addEventListener('touchstart', (e) => {
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      isDragging = true;
    }, { passive: true });
    
    canvas.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      if (state.hasGyroscope && state.gyroActive && !state.sensorsLocked) return;
      
      const dx = e.touches[0].clientX - touchStart.x;
      const dy = e.touches[0].clientY - touchStart.y;
      state.azimuth = (state.azimuth - dx * 0.5 + 360) % 360;
      state.altitude = Math.max(-90, Math.min(90, state.altitude - dy * 0.3));
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }, { passive: true });
    
    canvas.addEventListener('touchend', () => { isDragging = false; });
    
    canvas.addEventListener('mousedown', (e) => {
      isDragging = true;
      touchStart = { x: e.clientX, y: e.clientY };
    });
    
    canvas.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - touchStart.x;
      const dy = e.clientY - touchStart.y;
      state.azimuth = (state.azimuth - dx * 0.3 + 360) % 360;
      state.altitude = Math.max(-90, Math.min(90, state.altitude - dy * 0.3));
      touchStart = { x: e.clientX, y: e.clientY };
    });
    
    canvas.addEventListener('mouseup', () => { isDragging = false; });
    canvas.addEventListener('mouseleave', () => { isDragging = false; });
    
    // ==================== RENDERING ====================
    function getScreenPosition(objAz, objAlt, viewAz, viewAlt) {
      let dAz = objAz - viewAz;
      if (dAz > 180) dAz -= 360;
      if (dAz < -180) dAz += 360;
      
      const dAlt = objAlt - viewAlt;
      const hFov = state.fov;
      const vFov = state.fov;
      
      const x = canvas.width / 2 + (dAz / hFov) * canvas.width;
      const y = canvas.height / 2 - (dAlt / vFov) * canvas.height;
      const inView = Math.abs(dAz) < hFov && Math.abs(dAlt) < vFov;
      
      return { x, y, inView };
    }
    
    function drawCelestialObject(obj, viewAz, viewAlt, lst) {
      const { alt, az } = raDecToAltAz(obj.ra, obj.dec, state.latitude, lst);
      const pos = getScreenPosition(az, alt, viewAz, viewAlt);
      
      if (!pos.inView) return;
      
      const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, obj.size * 2.5);
      const color = state.nightMode ? '#ff6666' : obj.color;
      gradient.addColorStop(0, color);
      gradient.addColorStop(0.4, color + '88');
      gradient.addColorStop(1, 'transparent');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, obj.size * 2.5, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, obj.size / 2, 0, Math.PI * 2);
      ctx.fill();
      
      if (state.showLabels) {
        ctx.fillStyle = state.nightMode ? '#ff8888' : '#fff';
        ctx.font = 'bold 13px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#000';
        ctx.shadowBlur = 4;
        ctx.fillText(obj.name, pos.x, pos.y + obj.size + 14);
        ctx.shadowBlur = 0;
      }
    }
    
    function drawStar(star, viewAz, viewAlt, lst) {
      const [name, ra, dec, mag] = star;
      if (mag > state.maxMagnitude) return;
      
      const { alt, az } = raDecToAltAz(ra, dec, state.latitude, lst);
      const pos = getScreenPosition(az, alt, viewAz, viewAlt);
      
      if (!pos.inView) return;
      
      const size = Math.max(1.5, 4.5 - mag);
      const brightness = Math.min(255, Math.floor(255 * (2.5 - mag) / 3.5));
      
      if (state.nightMode) {
        ctx.fillStyle = `rgb(${brightness}, ${Math.floor(brightness*0.3)}, ${Math.floor(brightness*0.3)})`;
      } else {
        ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${Math.min(255, brightness + 30)})`;
      }
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
      ctx.fill();
      
      if (state.showLabels && mag < 1.0) {
        ctx.fillStyle = state.nightMode ? 'rgba(255,150,150,0.8)' : 'rgba(255,255,255,0.8)';
        ctx.font = '11px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(name, pos.x, pos.y + size + 12);
      }
    }
    
    function drawBackgroundStar(star, viewAz, viewAlt) {
      const pos = getScreenPosition(star.az, star.alt, viewAz, viewAlt);
      if (!pos.inView) return;
      
      if (state.nightMode) {
        ctx.fillStyle = `rgba(255, 100, 100, ${star.brightness * 0.5})`;
      } else {
        ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
      }
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, star.size, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function drawBackground() {
      let gradient;
      if (state.nightMode) {
        gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#1a0505');
        gradient.addColorStop(0.5, '#200808');
        gradient.addColorStop(1, '#150404');
      } else {
        gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#05051a');
        gradient.addColorStop(0.5, '#0a0a2e');
        gradient.addColorStop(1, '#12122a');
      }
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function drawGrid(viewAz, viewAlt) {
      if (!state.showGrid) return;
      
      ctx.strokeStyle = state.nightMode ? 'rgba(255,100,100,0.2)' : 'rgba(100,150,255,0.2)';
      ctx.lineWidth = 1;
      
      for (let alt = -90; alt <= 90; alt += 15) {
        ctx.beginPath();
        for (let az = 0; az <= 360; az += 5) {
          const pos = getScreenPosition(az, alt, viewAz, viewAlt);
          if (az === 0) ctx.moveTo(pos.x, pos.y);
          else ctx.lineTo(pos.x, pos.y);
        }
        ctx.stroke();
      }
      
      for (let az = 0; az < 360; az += 30) {
        ctx.beginPath();
        for (let alt = -90; alt <= 90; alt += 5) {
          const pos = getScreenPosition(az, alt, viewAz, viewAlt);
          if (alt === -90) ctx.moveTo(pos.x, pos.y);
          else ctx.lineTo(pos.x, pos.y);
        }
        ctx.stroke();
      }
    }
    
    function drawHorizonLine(viewAlt) {
      if (!state.showHorizon) return;
      
      const horizonY = canvas.height / 2 + (viewAlt / state.fov) * canvas.height;
      
      if (horizonY > 0 && horizonY < canvas.height) {
        ctx.strokeStyle = state.nightMode ? 'rgba(255,100,100,0.4)' : 'rgba(70, 130, 180, 0.4)';
        ctx.lineWidth = 2;
        ctx.setLineDash([15, 10]);
        ctx.beginPath();
        ctx.moveTo(0, horizonY);
        ctx.lineTo(canvas.width, horizonY);
        ctx.stroke();
        ctx.setLineDash([]);
        
        ctx.fillStyle = state.nightMode ? 'rgba(255,100,100,0.7)' : 'rgba(70, 130, 180, 0.7)';
        ctx.font = '12px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('--- Horizon ---', canvas.width / 2, horizonY - 8);
      }
    }
    
    function drawCardinalDirections(viewAz) {
      const directions = [
        { az: 0, label: 'N', color: '#ff6b6b' },
        { az: 90, label: 'E', color: '#ffd93d' },
        { az: 180, label: 'S', color: '#6bcb77' },
        { az: 270, label: 'W', color: '#4d96ff' }
      ];
      
      ctx.font = 'bold 20px -apple-system, sans-serif';
      ctx.textAlign = 'center';
      
      directions.forEach(dir => {
        let dAz = dir.az - viewAz;
        if (dAz > 180) dAz -= 360;
        if (dAz < -180) dAz += 360;
        
        if (Math.abs(dAz) < state.fov * 0.6) {
          const x = canvas.width / 2 + (dAz / state.fov) * canvas.width;
          ctx.fillStyle = state.nightMode ? '#ff6666' : dir.color;
          ctx.fillText(dir.label, x, canvas.height - 220);
        }
      });
    }
    
    function updateUI() {
      document.getElementById('az-display').textContent = `${state.azimuth.toFixed(0)} deg`;
      document.getElementById('alt-display').textContent = `${state.altitude.toFixed(0)} deg`;
      
      let sensorStatus = [];
      if (state.gyroActive) sensorStatus.push('Gyro');
      if (state.compassActive) sensorStatus.push('Compass');
      if (state.sensorsLocked) sensorStatus.push('(Locked)');
      document.getElementById('sensor-display').textContent = sensorStatus.length > 0 ? sensorStatus.join(' + ') : 'Off';
      
      const compassStatus = document.getElementById('compass-status');
      if (state.compassHeading !== null) {
        compassStatus.textContent = `True heading: ${state.compassHeading.toFixed(0)} deg`;
      } else if (state.compassActive) {
        compassStatus.textContent = 'Magnetic heading active';
      } else {
        compassStatus.textContent = '';
      }
      
      const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      const dirIndex = Math.round(state.azimuth / 45) % 8;
      document.getElementById('direction').textContent = dirs[dirIndex];
      document.getElementById('degrees').textContent = `${Math.round(state.azimuth)} deg`;
      
      if (!state.useCustomTime) {
        updateTimeDisplay(new Date());
      }
    }
    
    function animate() {
      const displayTime = getSelectedTime();
      const jd = julianDate(displayTime);
      const lst = localSiderealTime(jd, state.longitude);
      
      drawBackground();
      
      BACKGROUND_STARS.forEach(star => {
        drawBackgroundStar(star, state.azimuth, state.altitude);
      });
      
      drawGrid(state.azimuth, state.altitude);
      drawHorizonLine(state.altitude);
      drawCardinalDirections(state.azimuth);
      
      BRIGHT_STARS.forEach(star => {
        drawStar(star, state.azimuth, state.altitude, lst);
      });
      
      ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'].forEach(planet => {
        const obj = getPlanetPosition(jd, planet);
        drawCelestialObject(obj, state.azimuth, state.altitude, lst);
      });
      
      const moon = getMoonPosition(jd);
      drawCelestialObject(moon, state.azimuth, state.altitude, lst);
      
      const sun = getSunPosition(jd);
      drawCelestialObject(sun, state.azimuth, state.altitude, lst);
      
      updateUI();
      requestAnimationFrame(animate);
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>
