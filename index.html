<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Star Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      touch-action: none;
    }
    #sky-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,20,0.95);
      z-index: 100;
      padding: 20px;
      text-align: center;
    }
    #ui-overlay.hidden { display: none; }
    h1 { font-size: 28px; margin-bottom: 10px; }
    .subtitle { color: #88f; margin-bottom: 30px; font-size: 14px; }
    .btn {
      background: linear-gradient(135deg, #4a6cf7, #2d4ad8);
      border: none;
      color: white;
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px;
      min-width: 240px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(74,108,247,0.5); }
    .btn:disabled { background: #444; cursor: not-allowed; transform: none; }
    .btn.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .status { margin-top: 20px; font-size: 14px; color: #aaa; max-width: 300px; min-height: 24px; }
    #info-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,30,0.8);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 12px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #info-panel div { margin: 4px 0; }
    .label { color: #888; }
    #compass {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,30,0.8);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 16px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #legend {
      position: fixed;
      bottom: 20px;
      right: 10px;
      background: rgba(0,0,30,0.8);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 11px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .legend-item { display: flex; align-items: center; margin: 4px 0; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .instructions {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      max-width: 320px;
    }
    .instructions li { text-align: left; margin: 8px 0; font-size: 14px; }
    .permission-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 300px;
    }
    .step-icon {
      font-size: 24px;
      margin-right: 12px;
      width: 40px;
    }
    .step-status {
      font-size: 20px;
      margin-left: auto;
    }
    .step-text {
      text-align: left;
      flex: 1;
    }
    .step-title {
      font-weight: bold;
      font-size: 14px;
    }
    .step-desc {
      font-size: 11px;
      color: #888;
    }
    .gyro-note {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.5);
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 12px;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <canvas id="sky-canvas"></canvas>
  
  <div id="ui-overlay">
    <h1>‚≠ê Star Tracker</h1>
    <p class="subtitle">Point your phone at the sky to see stars & planets</p>
    
    <div class="permission-step">
      <span class="step-icon">üìç</span>
      <div class="step-text">
        <div class="step-title">Location</div>
        <div class="step-desc">To show stars visible from your position</div>
      </div>
      <span class="step-status" id="loc-status">‚è≥</span>
    </div>
    
    <div class="permission-step">
      <span class="step-icon">üì±</span>
      <div class="step-text">
        <div class="step-title">Gyroscope / Motion</div>
        <div class="step-desc">To track where you're pointing</div>
      </div>
      <span class="step-status" id="gyro-status">‚è≥</span>
    </div>
    
    <div class="gyro-note" id="ios-note" style="display:none;">
      ‚ö†Ô∏è <strong>iOS Users:</strong> You'll see a popup asking for "Motion & Orientation" access. Please tap <strong>Allow</strong> to enable gyroscope tracking!
    </div>
    
    <button class="btn" id="location-btn">üìç Grant Location Access</button>
    <button class="btn" id="gyro-btn" style="display:none;">üì± Enable Gyroscope</button>
    <button class="btn success" id="start-btn" style="display:none;">üöÄ Start Star Tracking!</button>
    
    <p class="status" id="status"></p>
  </div>
  
  <div id="info-panel" style="display:none;">
    <div><span class="label">Time:</span> <span id="time-display">--</span></div>
    <div><span class="label">Location:</span> <span id="loc-display">--</span></div>
    <div><span class="label">Azimuth:</span> <span id="az-display">--</span></div>
    <div><span class="label">Altitude:</span> <span id="alt-display">--</span></div>
    <div><span class="label">Gyro:</span> <span id="gyro-display">--</span></div>
  </div>
  
  <div id="compass" style="display:none;">
    <span id="direction">N</span> <span id="degrees">0¬∞</span>
  </div>
  
  <div id="legend" style="display:none;">
    <div class="legend-item"><div class="legend-dot" style="background:#FFD700;"></div> Sun</div>
    <div class="legend-item"><div class="legend-dot" style="background:#E8E8E8;"></div> Moon</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFA500;"></div> Planets</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFFFFF;"></div> Stars</div>
  </div>

  <script>
    // ==================== ASTRONOMICAL CALCULATIONS ====================
    const DEG2RAD = Math.PI / 180;
    const RAD2DEG = 180 / Math.PI;
    
    function julianDate(date) {
      const y = date.getUTCFullYear();
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate() + date.getUTCHours()/24 + date.getUTCMinutes()/1440 + date.getUTCSeconds()/86400;
      const a = Math.floor((14 - m) / 12);
      const yy = y + 4800 - a;
      const mm = m + 12 * a - 3;
      return d + Math.floor((153 * mm + 2) / 5) + 365 * yy + Math.floor(yy / 4) - Math.floor(yy / 100) + Math.floor(yy / 400) - 32045;
    }
    
    function localSiderealTime(jd, longitude) {
      const T = (jd - 2451545.0) / 36525;
      let LST = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * T * T - T * T * T / 38710000;
      LST = LST + longitude;
      LST = ((LST % 360) + 360) % 360;
      return LST;
    }
    
    function raDecToAltAz(ra, dec, lat, lst) {
      const ha = (lst - ra + 360) % 360;
      const haRad = ha * DEG2RAD;
      const decRad = dec * DEG2RAD;
      const latRad = lat * DEG2RAD;
      
      const sinAlt = Math.sin(decRad) * Math.sin(latRad) + Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
      const alt = Math.asin(sinAlt) * RAD2DEG;
      
      const cosAz = (Math.sin(decRad) - Math.sin(latRad) * sinAlt) / (Math.cos(latRad) * Math.cos(alt * DEG2RAD));
      let az = Math.acos(Math.max(-1, Math.min(1, cosAz))) * RAD2DEG;
      if (Math.sin(haRad) > 0) az = 360 - az;
      
      return { alt, az };
    }
    
    function getSunPosition(jd) {
      const n = jd - 2451545.0;
      const L = (280.460 + 0.9856474 * n) % 360;
      const g = (357.528 + 0.9856003 * n) % 360;
      const gRad = g * DEG2RAD;
      const lambda = L + 1.915 * Math.sin(gRad) + 0.020 * Math.sin(2 * gRad);
      const epsilon = 23.439 - 0.0000004 * n;
      const lambdaRad = lambda * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(Math.cos(epsilonRad) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilonRad) * Math.sin(lambdaRad)) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Sun', color: '#FFD700', size: 20 };
    }
    
    function getMoonPosition(jd) {
      const T = (jd - 2451545.0) / 36525;
      const L = (218.316 + 13.176396 * (jd - 2451545.0)) % 360;
      const M = (134.963 + 13.064993 * (jd - 2451545.0)) % 360;
      const F = (93.272 + 13.229350 * (jd - 2451545.0)) % 360;
      
      const longitude = L + 6.289 * Math.sin(M * DEG2RAD);
      const latitude = 5.128 * Math.sin(F * DEG2RAD);
      const epsilon = 23.439;
      
      const lambdaRad = longitude * DEG2RAD;
      const betaRad = latitude * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(
        Math.sin(lambdaRad) * Math.cos(epsilonRad) - Math.tan(betaRad) * Math.sin(epsilonRad),
        Math.cos(lambdaRad)
      ) * RAD2DEG;
      const dec = Math.asin(
        Math.sin(betaRad) * Math.cos(epsilonRad) + Math.cos(betaRad) * Math.sin(epsilonRad) * Math.sin(lambdaRad)
      ) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Moon', color: '#E8E8E8', size: 18 };
    }
    
    function getPlanetPosition(jd, planet) {
      const n = jd - 2451545.0;
      const planets = {
        Mercury: { L0: 252.251, Lrate: 4.09233, a: 0.387, e: 0.2056, i: 7.0, node: 48.33, peri: 29.12 },
        Venus: { L0: 181.980, Lrate: 1.60213, a: 0.723, e: 0.0068, i: 3.39, node: 76.68, peri: 54.88 },
        Mars: { L0: 355.433, Lrate: 0.52403, a: 1.524, e: 0.0934, i: 1.85, node: 49.56, peri: 286.50 },
        Jupiter: { L0: 34.351, Lrate: 0.08309, a: 5.203, e: 0.0484, i: 1.31, node: 100.46, peri: 275.07 },
        Saturn: { L0: 50.077, Lrate: 0.03346, a: 9.537, e: 0.0542, i: 2.49, node: 113.64, peri: 336.01 }
      };
      
      const p = planets[planet];
      const L = (p.L0 + p.Lrate * n) % 360;
      const M = L - p.peri;
      const MRad = M * DEG2RAD;
      
      const epsilon = 23.439;
      const lambdaRad = L * DEG2RAD;
      const ra = Math.atan2(Math.cos(epsilon * DEG2RAD) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilon * DEG2RAD) * Math.sin(lambdaRad)) * RAD2DEG;
      
      const colors = { Mercury: '#B5B5B5', Venus: '#FFFACD',
