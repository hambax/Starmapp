<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Star Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    #sky-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,20,0.95);
      z-index: 1000;
      padding: 20px;
      text-align: center;
      touch-action: auto;
    }
    #ui-overlay.hidden { display: none; }
    h1 { font-size: 28px; margin-bottom: 10px; }
    .subtitle { color: #88f; margin-bottom: 30px; font-size: 14px; }
    .btn {
      background: linear-gradient(135deg, #4a6cf7, #2d4ad8);
      border: none;
      color: white;
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px;
      min-width: 240px;
      transition: transform 0.2s, box-shadow 0.2s;
      -webkit-tap-highlight-color: rgba(255,255,255,0.2);
      touch-action: manipulation;
      user-select: none;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: #444; cursor: not-allowed; transform: none; opacity: 0.7; }
    .btn.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .status { margin-top: 20px; font-size: 14px; color: #aaa; max-width: 300px; min-height: 24px; }
    #info-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,30,0.8);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 12px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      pointer-events: none;
    }
    #info-panel div { margin: 4px 0; }
    .label { color: #888; }
    #compass {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,30,0.8);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 16px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      pointer-events: none;
    }
    #legend {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,30,0.8);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 11px;
      z-index: 50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      pointer-events: none;
    }
    .legend-item { display: flex; align-items: center; margin: 4px 0; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .permission-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 300px;
    }
    .step-icon { font-size: 24px; margin-right: 12px; width: 40px; }
    .step-status { font-size: 20px; margin-left: auto; }
    .step-text { text-align: left; flex: 1; }
    .step-title { font-weight: bold; font-size: 14px; }
    .step-desc { font-size: 11px; color: #888; }
    .gyro-note {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.5);
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 12px;
      max-width: 300px;
    }
    
    /* Time Control Panel */
    #time-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,30,0.9);
      padding: 15px;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    @media (min-width: 768px) {
      #time-panel {
        right: auto;
        width: 320px;
        border-radius: 0 10px 0 0;
        border-right: 1px solid rgba(255,255,255,0.1);
      }
      #compass {
        bottom: 20px;
      }
    }
    
    .time-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .time-panel-title {
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .time-mode-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      background: #22c55e;
      color: white;
    }
    
    .time-mode-badge.planning {
      background: #f59e0b;
    }
    
    .time-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .time-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .time-input-group {
      flex: 1;
    }
    
    .time-input-group label {
      display: block;
      font-size: 10px;
      color: #888;
      margin-bottom: 4px;
    }
    
    .time-input-group input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
      font-family: inherit;
    }
    
    .time-input-group input:focus {
      outline: none;
      border-color: #4a6cf7;
    }
    
    .time-buttons {
      display: flex;
      gap: 8px;
      margin-top: 5px;
    }
    
    .time-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    
    .time-btn.now {
      background: #22c55e;
      color: white;
    }
    
    .time-btn.now:hover {
      background: #16a34a;
    }
    
    .time-btn.offset {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .time-btn.offset:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .selected-time-display {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      margin-top: 8px;
    }
    
    .selected-time-display .time-big {
      font-size: 20px;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
    }
    
    .selected-time-display .date-small {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <canvas id="sky-canvas"></canvas>
  
  <div id="ui-overlay">
    <h1>‚≠ê Star Tracker</h1>
    <p class="subtitle">Point your phone at the sky to see stars & planets</p>
    
    <div class="permission-step">
      <span class="step-icon">üìç</span>
      <div class="step-text">
        <div class="step-title">Location</div>
        <div class="step-desc">To show stars visible from your position</div>
      </div>
      <span class="step-status" id="loc-status">‚è≥</span>
    </div>
    
    <div class="permission-step">
      <span class="step-icon">üì±</span>
      <div class="step-text">
        <div class="step-title">Gyroscope / Motion</div>
        <div class="step-desc">To track where you're pointing</div>
      </div>
      <span class="step-status" id="gyro-status">‚è≥</span>
    </div>
    
    <div class="gyro-note" id="ios-note" style="display:none;">
      ‚ö†Ô∏è <strong>iOS Users:</strong> Tap "Enable Gyroscope" and allow "Motion & Orientation" access!
    </div>
    
    <button class="btn" id="location-btn" type="button">üìç Grant Location Access</button>
    <button class="btn" id="gyro-btn" type="button" style="display:none;">üì± Enable Gyroscope</button>
    <button class="btn success" id="start-btn" type="button" style="display:none;">üöÄ Start Star Tracking!</button>
    
    <p class="status" id="status"></p>
  </div>
  
  <div id="info-panel" style="display:none;">
    <div><span class="label">Location:</span> <span id="loc-display">--</span></div>
    <div><span class="label">Facing:</span> <span id="az-display">--</span></div>
    <div><span class="label">Elevation:</span> <span id="alt-display">--</span></div>
    <div><span class="label">Gyro:</span> <span id="gyro-display">--</span></div>
  </div>
  
  <div id="compass" style="display:none;">
    <span id="direction">N</span> <span id="degrees">0¬∞</span>
  </div>
  
  <div id="legend" style="display:none;">
    <div class="legend-item"><div class="legend-dot" style="background:#FFD700;"></div> Sun</div>
    <div class="legend-item"><div class="legend-dot" style="background:#E8E8E8;"></div> Moon</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFA500;"></div> Planets</div>
    <div class="legend-item"><div class="legend-dot" style="background:#FFFFFF;"></div> Stars</div>
  </div>
  
  <!-- Time Control Panel -->
  <div id="time-panel" style="display:none;">
    <div class="time-panel-header">
      <div class="time-panel-title">
        üì∑ Photo Planner
        <span class="time-mode-badge" id="time-mode-badge">LIVE</span>
      </div>
    </div>
    
    <div class="time-controls">
      <div class="time-row">
        <div class="time-input-group">
          <label>Date</label>
          <input type="date" id="date-input">
        </div>
        <div class="time-input-group">
          <label>Time</label>
          <input type="time" id="time-input">
        </div>
      </div>
      
      <div class="time-buttons">
        <button class="time-btn now" id="now-btn" type="button">‚è± Now</button>
        <button class="time-btn offset" id="plus1h-btn" type="button">+1h</button>
        <button class="time-btn offset" id="plus3h-btn" type="button">+3h</button>
        <button class="time-btn offset" id="sunset-btn" type="button">üåÖ Sunset</button>
      </div>
      
      <div class="selected-time-display">
        <div class="time-big" id="display-time">--:--:--</div>
        <div class="date-small" id="display-date">----</div>
      </div>
    </div>
  </div>

  <script>
    const DEG2RAD = Math.PI / 180;
    const RAD2DEG = 180 / Math.PI;
    
    function julianDate(date) {
      const y = date.getUTCFullYear();
      const m = date.getUTCMonth() + 1;
      const d = date.getUTCDate() + date.getUTCHours()/24 + date.getUTCMinutes()/1440 + date.getUTCSeconds()/86400;
      const a = Math.floor((14 - m) / 12);
      const yy = y + 4800 - a;
      const mm = m + 12 * a - 3;
      return d + Math.floor((153 * mm + 2) / 5) + 365 * yy + Math.floor(yy / 4) - Math.floor(yy / 100) + Math.floor(yy / 400) - 32045;
    }
    
    function localSiderealTime(jd, longitude) {
      const T = (jd - 2451545.0) / 36525;
      let LST = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * T * T - T * T * T / 38710000;
      LST = LST + longitude;
      LST = ((LST % 360) + 360) % 360;
      return LST;
    }
    
    function raDecToAltAz(ra, dec, lat, lst) {
      const ha = (lst - ra + 360) % 360;
      const haRad = ha * DEG2RAD;
      const decRad = dec * DEG2RAD;
      const latRad = lat * DEG2RAD;
      
      const sinAlt = Math.sin(decRad) * Math.sin(latRad) + Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
      const alt = Math.asin(sinAlt) * RAD2DEG;
      
      const cosAz = (Math.sin(decRad) - Math.sin(latRad) * sinAlt) / (Math.cos(latRad) * Math.cos(alt * DEG2RAD));
      let az = Math.acos(Math.max(-1, Math.min(1, cosAz))) * RAD2DEG;
      if (Math.sin(haRad) > 0) az = 360 - az;
      
      return { alt, az };
    }
    
    function getSunPosition(jd) {
      const n = jd - 2451545.0;
      const L = (280.460 + 0.9856474 * n) % 360;
      const g = (357.528 + 0.9856003 * n) % 360;
      const gRad = g * DEG2RAD;
      const lambda = L + 1.915 * Math.sin(gRad) + 0.020 * Math.sin(2 * gRad);
      const epsilon = 23.439 - 0.0000004 * n;
      const lambdaRad = lambda * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(Math.cos(epsilonRad) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilonRad) * Math.sin(lambdaRad)) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Sun', color: '#FFD700', size: 20 };
    }
    
    function getMoonPosition(jd) {
      const L = (218.316 + 13.176396 * (jd - 2451545.0)) % 360;
      const M = (134.963 + 13.064993 * (jd - 2451545.0)) % 360;
      const F = (93.272 + 13.229350 * (jd - 2451545.0)) % 360;
      
      const longitude = L + 6.289 * Math.sin(M * DEG2RAD);
      const latitude = 5.128 * Math.sin(F * DEG2RAD);
      const epsilon = 23.439;
      
      const lambdaRad = longitude * DEG2RAD;
      const betaRad = latitude * DEG2RAD;
      const epsilonRad = epsilon * DEG2RAD;
      
      const ra = Math.atan2(
        Math.sin(lambdaRad) * Math.cos(epsilonRad) - Math.tan(betaRad) * Math.sin(epsilonRad),
        Math.cos(lambdaRad)
      ) * RAD2DEG;
      const dec = Math.asin(
        Math.sin(betaRad) * Math.cos(epsilonRad) + Math.cos(betaRad) * Math.sin(epsilonRad) * Math.sin(lambdaRad)
      ) * RAD2DEG;
      
      return { ra: (ra + 360) % 360, dec, name: 'Moon', color: '#E8E8E8', size: 18 };
    }
    
    function getPlanetPosition(jd, planet) {
      const n = jd - 2451545.0;
      const planets = {
        Mercury: { L0: 252.251, Lrate: 4.09233 },
        Venus: { L0: 181.980, Lrate: 1.60213 },
        Mars: { L0: 355.433, Lrate: 0.52403 },
        Jupiter: { L0: 34.351, Lrate: 0.08309 },
        Saturn: { L0: 50.077, Lrate: 0.03346 }
      };
      
      const p = planets[planet];
      const L = (p.L0 + p.Lrate * n) % 360;
      const epsilon = 23.439;
      const lambdaRad = L * DEG2RAD;
      const ra = Math.atan2(Math.cos(epsilon * DEG2RAD) * Math.sin(lambdaRad), Math.cos(lambdaRad)) * RAD2DEG;
      const dec = Math.asin(Math.sin(epsilon * DEG2RAD) * Math.sin(lambdaRad)) * RAD2DEG;
      
      const colors = { Mercury: '#B5B5B5', Venus: '#FFFACD', Mars: '#FF6B4A', Jupiter: '#FFB347', Saturn: '#F4D03F' };
      const sizes = { Mercury: 6, Venus: 10, Mars: 8, Jupiter: 14, Saturn: 12 };
      
      return { ra: (ra + 360) % 360, dec, name: planet, color: colors[planet], size: sizes[planet] };
    }
    
    // Calculate approximate sunset time for a given date and location
    function getSunsetTime(date, lat, lng) {
      const jd = julianDate(date);
      const n = jd - 2451545.0;
      const Jstar = n - lng / 360;
      const M = (357.5291 + 0.98560028 * Jstar) % 360;
      const C = 1.9148 * Math.sin(M * DEG2RAD) + 0.02 * Math.sin(2 * M * DEG2RAD);
      const lambda = (M + C + 180 + 102.9372) % 360;
      const delta = Math.asin(Math.sin(lambda * DEG2RAD) * Math.sin(23.44 * DEG2RAD)) * RAD2DEG;
      const cosOmega = (Math.sin(-0.83 * DEG2RAD) - Math.sin(lat * DEG2RAD) * Math.sin(delta * DEG2RAD)) / 
                       (Math.cos(lat * DEG2RAD) * Math.cos(delta * DEG2RAD));
      
      if (Math.abs(cosOmega) > 1) return null; // No sunset (polar day/night)
      
      const omega = Math.acos(cosOmega) * RAD2DEG;
      const Jtransit = 2451545.0 + Jstar + 0.0053 * Math.sin(M * DEG2RAD) - 0.0069 * Math.sin(2 * lambda * DEG2RAD);
      const Jset = Jtransit + omega / 360;
      
      // Convert Julian date back to Date object
      const sunsetJD = Jset;
      const Z = Math.floor(sunsetJD + 0.5);
      const F = sunsetJD + 0.5 - Z;
      const A = Math.floor((Z - 1867216.25) / 36524.25);
      const B = Z + 1 + A - Math.floor(A / 4);
      const C2 = B + 1524;
      const D = Math.floor((C2 - 122.1) / 365.25);
      const E = Math.floor(365.25 * D);
      const G = Math.floor((C2 - E) / 30.6001);
      
      const day = C2 - E - Math.floor(30.6001 * G) + F;
      const month = G < 14 ? G - 1 : G - 13;
      const year = month > 2 ? D - 4716 : D - 4715;
      
      const hours = (day % 1) * 24;
      const sunsetDate = new Date(year, month - 1, Math.floor(day), Math.floor(hours), Math.floor((hours % 1) * 60));
      
      return sunsetDate;
    }
    
    const BRIGHT_STARS = [
      ['Sirius', 101.29, -16.72, -1.46], ['Canopus', 95.99, -52.70, -0.72],
      ['Arcturus', 213.92, 19.18, -0.05], ['Vega', 279.23, 38.78, 0.03],
      ['Capella', 79.17, 45.99, 0.08], ['Rigel', 78.63, -8.20, 0.13],
      ['Procyon', 114.83, 5.22, 0.34], ['Betelgeuse', 88.79, 7.41, 0.42],
      ['Altair', 297.70, 8.87, 0.76], ['Aldebaran', 68.98, 16.51, 0.85],
      ['Antares', 247.35, -26.43, 0.96], ['Spica', 201.30, -11.16, 0.97],
      ['Pollux', 116.33, 28.03, 1.14], ['Fomalhaut', 344.41, -29.62, 1.16],
      ['Deneb', 310.36, 45.28, 1.25], ['Regulus', 152.09, 11.97, 1.35],
      ['Polaris', 37.95, 89.26, 1.98], ['Castor', 113.65, 31.89, 1.58]
    ];
    
    const BACKGROUND_STARS = [];
    for (let i = 0; i < 400; i++) {
      const az = (Math.sin(i * 567.89) * 0.5 + 0.5) * 360;
      const alt = (Math.cos(i * 123.45) * 0.5 + 0.5) * 180 - 90;
      const size = (i % 4) * 0.3 + 0.4;
      const brightness = 0.3 + (i % 5) * 0.1;
      BACKGROUND_STARS.push({ az, alt, size, brightness });
    }
    
    let state = {
      hasLocation: false,
      hasGyroscope: false,
      gyroActive: false,
      latitude: 51.5,
      longitude: -0.1,
      alpha: 0, beta: 0, gamma: 0,
      azimuth: 180,
      altitude: 45,
      // Time planning
      useCustomTime: false,
      customTime: new Date()
    };
    
    const canvas = document.getElementById('sky-canvas');
    const ctx = canvas.getContext('2d');
    
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    if (isIOS) {
      document.getElementById('ios-note').style.display = 'block';
    }
    
    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }
    
    function hideOverlay() {
      document.getElementById('ui-overlay').classList.add('hidden');
      document.getElementById('info-panel').style.display = 'block';
      document.getElementById('compass').style.display = 'block';
      document.getElementById('legend').style.display = 'block';
      document.getElementById('time-panel').style.display = 'block';
      initTimePanel();
    }
    
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    // ==================== TIME PANEL ====================
    function initTimePanel() {
      const now = new Date();
      updateTimeInputs(now);
      updateTimeDisplay(now);
    }
    
    function updateTimeInputs(date) {
      const dateStr = date.toISOString().split('T')[0];
      const timeStr = date.toTimeString().slice(0, 5);
      document.getElementById('date-input').value = dateStr;
      document.getElementById('time-input').value = timeStr;
    }
    
    function updateTimeDisplay(date) {
      document.getElementById('display-time').textContent = date.toLocaleTimeString();
      document.getElementById('display-date').textContent = date.toLocaleDateString(undefined, { 
        weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' 
      });
      
      const badge = document.getElementById('time-mode-badge');
      if (state.useCustomTime) {
        badge.textContent = 'PLANNING';
        badge.classList.add('planning');
      } else {
        badge.textContent = 'LIVE';
        badge.classList.remove('planning');
      }
    }
    
    function getSelectedTime() {
      if (state.useCustomTime) {
        return state.customTime;
      }
      return new Date();
    }
    
    function setCustomTime(date) {
      state.useCustomTime = true;
      state.customTime = date;
      updateTimeInputs(date);
      updateTimeDisplay(date);
    }
    
    function setLiveTime() {
      state.useCustomTime = false;
      const now = new Date();
      updateTimeInputs(now);
      updateTimeDisplay(now);
    }
    
    // Time panel event listeners
    document.getElementById('date-input').addEventListener('change', function() {
      const dateVal = this.value;
      const timeVal = document.getElementById('time-input').value || '12:00';
      const newDate = new Date(dateVal + 'T' + timeVal);
      if (!isNaN(newDate)) {
        setCustomTime(newDate);
      }
    });
    
    document.getElementById('time-input').addEventListener('change', function() {
      const dateVal = document.getElementById('date-input').value || new Date().toISOString().split('T')[0];
      const timeVal = this.value;
      const newDate = new Date(dateVal + 'T' + timeVal);
      if (!isNaN(newDate)) {
        setCustomTime(newDate);
      }
    });
    
    document.getElementById('now-btn').addEventListener('click', setLiveTime);
    
    document.getElementById('plus1h-btn').addEventListener('click', function() {
      const base = state.useCustomTime ? state.customTime : new Date();
      const newDate = new Date(base.getTime() + 60 * 60 * 1000);
      setCustomTime(newDate);
    });
    
    document.getElementById('plus3h-btn').addEventListener('click', function() {
      const base = state.useCustomTime ? state.customTime : new Date();
      const newDate = new Date(base.getTime() + 3 * 60 * 60 * 1000);
      setCustomTime(newDate);
    });
    
    document.getElementById('sunset-btn').addEventListener('click', function() {
      const today = new Date();
      const sunset = getSunsetTime(today, state.latitude, state.longitude);
      if (sunset) {
        setCustomTime(sunset);
      } else {
        alert('Cannot calculate sunset for this location/date');
      }
    });
    
    // ==================== LOCATION BUTTON ====================
    const locationBtn = document.getElementById('location-btn');
    locationBtn.addEventListener('click', handleLocationClick);
    locationBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      handleLocationClick();
    });
    
    async function handleLocationClick() {
      const btn = document.getElementById('location-btn');
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = 'üìç Requesting...';
      updateStatus('Please allow location access...');
      
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000
          });
        });
        
        state.latitude = position.coords.latitude;
        state.longitude = position.coords.longitude;
        state.hasLocation = true;
        
        document.getElementById('loc-status').textContent = '‚úÖ';
        document.getElementById('loc-display').textContent = 
          `${state.latitude.toFixed(2)}¬∞, ${state.longitude.toFixed(2)}¬∞`;
        btn.textContent = 'üìç Location Granted!';
        btn.classList.add('success');
        updateStatus('Great! Now enable gyroscope for motion tracking.');
        
      } catch (e) {
        document.getElementById('loc-status').textContent = '‚ö†Ô∏è';
        btn.textContent = 'üìç Using Default Location';
        btn.classList.add('warning');
        state.hasLocation = true;
        updateStatus('Using London as default location.');
      }
      
      document.getElementById('gyro-btn').style.display = 'block';
    }
    
    // ==================== GYROSCOPE BUTTON ====================
    const gyroBtn = document.getElementById('gyro-btn');
    gyroBtn.addEventListener('click', handleGyroClick);
    gyroBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      handleGyroClick();
    });
    
    async function handleGyroClick() {
      const btn = document.getElementById('gyro-btn');
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = 'üì± Requesting...';
      updateStatus('Please allow motion access...');
      
      let permissionGranted = false;
      
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceOrientationEvent.requestPermission();
          permissionGranted = (permission === 'granted');
        } catch (e) {
          console.error('Permission request failed:', e);
        }
      } else {
        permissionGranted = true;
      }
      
      if (permissionGranted) {
        window.addEventListener('deviceorientation', handleOrientation, true);
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        
        await new Promise(r => setTimeout(r, 800));
        
        if (state.gyroActive) {
          state.hasGyroscope = true;
          document.getElementById('gyro-status').textContent = '‚úÖ';
          btn.textContent = 'üì± Gyroscope Active!';
          btn.classList.add('success');
          updateStatus('Gyroscope working! Tap Start to begin.');
        } else {
          document.getElementById('gyro-status').textContent = '‚ö†Ô∏è';
          btn.textContent = 'üì± Using Touch Controls';
          btn.classList.add('warning');
          updateStatus('No gyro data. Drag to look around.');
        }
      } else {
        document.getElementById('gyro-status').textContent = '‚ùå';
        btn.textContent = 'üì± Permission Denied';
        btn.classList.add('warning');
        updateStatus('Motion access denied. Drag to look around.');
      }
      
      document.getElementById('start-btn').style.display = 'block';
    }
    
    function handleOrientation(event) {
      if (event.alpha !== null || event.beta !== null || event.gamma !== null) {
        state.gyroActive = true;
        state.alpha = event.alpha || 0;
        state.beta = event.beta || 0;
        state.gamma = event.gamma || 0;
        
        // Calculate compass heading
        if (event.webkitCompassHeading !== undefined) {
          state.azimuth = event.webkitCompassHeading;
        } else {
          state.azimuth = (360 - state.alpha) % 360;
        }
        
        // FIXED: Calculate altitude from phone tilt
        // beta = 0 when phone flat (looking at zenith, alt=90)
        // beta = 90 when phone vertical (looking at horizon, alt=0)
        // beta = 180 when phone flat upside down (looking at nadir, alt=-90)
        state.altitude = 90 - state.beta;
        
        // Clamp to valid range
        state.altitude = Math.max(-90, Math.min(90, state.altitude));
      }
    }
    
    // ==================== START BUTTON ====================
    const startBtn = document.getElementById('start-btn');
    startBtn.addEventListener('click', handleStartClick);
    startBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      handleStartClick();
    });
    
    function handleStartClick() {
      hideOverlay();
      requestAnimationFrame(animate);
    }
    
    // ==================== TOUCH/MOUSE CONTROLS ====================
    let touchStart = { x: 0, y: 0 };
    let isDragging = false;
    
    canvas.addEventListener('touchstart', (e) => {
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      isDragging = true;
    }, { passive: true });
    
    canvas.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      if (state.hasGyroscope && state.gyroActive) return;
      
      const dx = e.touches[0].clientX - touchStart.x;
      const dy = e.touches[0].clientY - touchStart.y;
      state.azimuth = (state.azimuth - dx * 0.5 + 360) % 360;
      state.altitude = Math.max(-90, Math.min(90, state.altitude + dy * 0.3));
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }, { passive: true });
    
    canvas.addEventListener('touchend', () => { isDragging = false; });
    
    canvas.addEventListener('mousedown', (e) => {
      isDragging = true;
      touchStart = { x: e.clientX, y: e.clientY };
    });
    
    canvas.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - touchStart.x;
      const dy = e.clientY - touchStart.y;
      state.azimuth = (state.azimuth - dx * 0.3 + 360) % 360;
      state.altitude = Math.max(-90, Math.min(90, state.altitude + dy * 0.3));
      touchStart = { x: e.clientX, y: e.clientY };
    });
    
    canvas.addEventListener('mouseup', () => { isDragging = false; });
    canvas.addEventListener('mouseleave', () => { isDragging = false; });
    
    // ==================== RENDERING ====================
    function getScreenPosition(objAz, objAlt, viewAz, viewAlt) {
      let dAz = objAz - viewAz;
      if (dAz > 180) dAz -= 360;
      if (dAz < -180) dAz += 360;
      
      const dAlt = objAlt - viewAlt;
      const hFov = 80;
      const vFov = 80;
      
      const x = canvas.width / 2 + (dAz / hFov) * canvas.width;
      const y = canvas.height / 2 - (dAlt / vFov) * canvas.height;
      const inView = Math.abs(dAz) < hFov && Math.abs(dAlt) < vFov;
      
      return { x, y, inView };
    }
    
    function drawCelestialObject(obj, viewAz, viewAlt, lst) {
      const { alt, az } = raDecToAltAz(obj.ra, obj.dec, state.latitude, lst);
      const pos = getScreenPosition(az, alt, viewAz, viewAlt);
      
      if (!pos.inView) return;
      
      const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, obj.size * 2.5);
      gradient.addColorStop(0, obj.color);
      gradient.addColorStop(0.4, obj.color + '88');
      gradient.addColorStop(1, 'transparent');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, obj.size * 2.5, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = obj.color;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, obj.size / 2, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 13px -apple-system, sans-serif';
      ctx.textAlign = 'center';
      ctx.shadowColor = '#000';
      ctx.shadowBlur = 4;
      ctx.fillText(obj.name, pos.x, pos.y + obj.size + 14);
      ctx.shadowBlur = 0;
    }
    
    function drawStar(star, viewAz, viewAlt, lst) {
      const [name, ra, dec, mag] = star;
      const { alt, az } = raDecToAltAz(ra, dec, state.latitude, lst);
      const pos = getScreenPosition(az, alt, viewAz, viewAlt);
      
      if (!pos.inView) return;
      
      const size = Math.max(1.5, 4.5 - mag);
      const brightness = Math.min(255, Math.floor(255 * (2.5 - mag) / 3.5));
      
      ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${Math.min(255, brightness + 30)})`;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
      ctx.fill();
      
      if (mag < 1.0) {
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = '11px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(name, pos.x, pos.y + size + 12);
      }
    }
    
    function drawBackgroundStar(star, viewAz, viewAlt) {
      const pos = getScreenPosition(star.az, star.alt, viewAz, viewAlt);
      
      if (!pos.inView) return;
      
      ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, star.size, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function drawBackground() {
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#05051a');
      gradient.addColorStop(0.5, '#0a0a2e');
      gradient.addColorStop(1, '#12122a');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function drawHorizonLine(viewAlt) {
      const horizonY = canvas.height / 2 + (viewAlt / 90) * canvas.height;
      
      if (horizonY > 0 && horizonY < canvas.height) {
        ctx.strokeStyle = 'rgba(70, 130, 180, 0.4)';
        ctx.lineWidth = 2;
        ctx.setLineDash([15, 10]);
        ctx.beginPath();
        ctx.moveTo(0, horizonY);
        ctx.lineTo(canvas.width, horizonY);
        ctx.stroke();
        ctx.setLineDash([]);
        
        ctx.fillStyle = 'rgba(70, 130, 180, 0.7)';
        ctx.font = '12px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('‚îÄ‚îÄ‚îÄ Horizon ‚îÄ‚îÄ‚îÄ', canvas.width / 2, horizonY - 8);
      }
    }
    
    function drawCardinalDirections(viewAz) {
      const directions = [
        { az: 0, label: 'N', color: '#ff6b6b' },
        { az: 90, label: 'E', color: '#ffd93d' },
        { az: 180, label: 'S', color: '#6bcb77' },
        { az: 270, label: 'W', color: '#4d96ff' }
      ];
      
      ctx.font = 'bold 20px -apple-system, sans-serif';
      ctx.textAlign = 'center';
      
      directions.forEach(dir => {
        let dAz = dir.az - viewAz;
        if (dAz > 180) dAz -= 360;
        if (dAz < -180) dAz += 360;
        
        if (Math.abs(dAz) < 50) {
          const x = canvas.width / 2 + (dAz / 80) * canvas.width;
          ctx.fillStyle = dir.color;
          ctx.fillText(dir.label, x, canvas.height - 160);
        }
      });
    }
    
    function updateUI() {
      const displayTime = getSelectedTime();
      
      document.getElementById('az-display').textContent = `${state.azimuth.toFixed(0)}¬∞`;
      document.getElementById('alt-display').textContent = `${state.altitude.toFixed(0)}¬∞`;
      document.getElementById('gyro-display').textContent = state.gyroActive ? '‚úì Active' : '‚úó Inactive';
      
      const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      const dirIndex = Math.round(state.azimuth / 45) % 8;
      document.getElementById('direction').textContent = dirs[dirIndex];
      document.getElementById('degrees').textContent = `${Math.round(state.azimuth)}¬∞`;
      
      // Update time display
      if (!state.useCustomTime) {
        updateTimeDisplay(new Date());
      }
    }
    
    function animate() {
      const displayTime = getSelectedTime();
      const jd = julianDate(displayTime);
      const lst = localSiderealTime(jd, state.longitude);
      
      drawBackground();
      
      BACKGROUND_STARS.forEach(star => {
        drawBackgroundStar(star, state.azimuth, state.altitude);
      });
      
      drawHorizonLine(state.altitude);
      drawCardinalDirections(state.azimuth);
      
      BRIGHT_STARS.forEach(star => {
        drawStar(star, state.azimuth, state.altitude, lst);
      });
      
      ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'].forEach(planet => {
        const obj = getPlanetPosition(jd, planet);
        drawCelestialObject(obj, state.azimuth, state.altitude, lst);
      });
      
      const moon = getMoonPosition(jd);
      drawCelestialObject(moon, state.azimuth, state.altitude, lst);
      
      const sun = getSunPosition(jd);
      drawCelestialObject(sun, state.azimuth, state.altitude, lst);
      
      updateUI();
      requestAnimationFrame(animate);
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>
